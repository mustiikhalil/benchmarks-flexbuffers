# [WIP] Benchmarks for FlexBuffers Swift

## ⚠️⚠️ WIP

- Currently Decoding Flexbuffers doesnt work
- Currently only the normal way of writing flexbuffers is supported
- The vision for the future is to add some type of Codable protocol to make it easier for users to write flexbuffers
- Havent tested the written flexbuffers Binaries 
- Test different optimizations for the Canada implementations since i am not familiar with the data yet (use indirect vectors maybe).

## Introduction

The following Repository compares the benchmarks between the native swift JSON encoder and decode 
compared to the FlexBuffers implementation. The vision of flexbuffers API within swift is to be something
similar to this:

```swift
struct Position: FlexBufferCodable { let x, y, z: Double }

let a = Position(x: 3.0, y: 4.0, z: 5.0)

let buffer: ByteBuffer = FlexBufferCoder().encode(a)

let pos = FlexBufferCoder().decode(buffer, as: Position.self)
```

## Size comparison

Within the resources folder you would find the binaries and jsons

| Keys                             | Twitter | Canada |
| -------------------------------- | :-----: | -----: |
| JSON                             |  617K   |   2.1M |
| FlexBuffer shared key            |  136K   |   2.9M |
| FlexBuffer shared key and string |   93K   |   1.9M |


## Readable Benchmarks

`swift package benchmark --grouping metric --time-units nanoseconds`

```
Host 'Mustiis-MacBook-Pro.local' with 12 'arm64' processors with 24 GB memory, running:
Darwin Kernel Version 24.5.0: Tue Apr 22 19:53:27 PDT 2025; root:xnu-11417.121.6~2/RELEASE_ARM64_T6041

Throughput (# / s)
╒═════════════════════════════════════════════════════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Test                                                                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═════════════════════════════════════════════════════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Benchmarks:Canada-decodeFromJSON (K)                                    │        64 │        62 │        62 │        62 │        61 │        60 │        60 │       186 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Canada-encodeToJSON (K)                                      │        32 │        30 │        30 │        30 │        30 │        29 │        29 │        91 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Canada-manual-encodeToFlexbufferSharedKeys (K)               │       321 │       296 │       295 │       292 │       289 │       272 │       255 │       881 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Canada-manual-encodeToFlexbufferSharedKeysAndStrings (K)     │       249 │       236 │       235 │       233 │       232 │       223 │       214 │       703 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-decodeFromJSON (K)                                   │       806 │       727 │       715 │       710 │       706 │       668 │       630 │      2149 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-encodeToJSON (K)                                     │      1549 │      1422 │      1401 │      1377 │      1362 │      1328 │      1208 │      4195 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-manual-encodeToFlexbufferSharedKeys (K)              │      3577 │      3255 │      3203 │      3163 │      3117 │      2997 │      2650 │      9577 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-manual-encodeToFlexbufferSharedKeysAndStrings (K)    │      1658 │      1508 │      1491 │      1474 │      1463 │      1411 │      1268 │      4468 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-manual-reading-FlexbufferSharedKeys (M)              │      2183 │      1716 │      1601 │      1601 │      1601 │      1500 │        17 │   1524405 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-manual-reading-FlexbufferSharedKeysAndStrings (M)    │      2183 │      1716 │      1601 │      1601 │      1601 │      1413 │        40 │   1531897 │
╘═════════════════════════════════════════════════════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Time (total CPU)
╒═════════════════════════════════════════════════════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Test                                                                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═════════════════════════════════════════════════════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Benchmarks:Canada-decodeFromJSON (ns) *                                 │     15506 │     16040 │     16155 │     16245 │     16359 │     16638 │     16654 │       186 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Canada-encodeToJSON (ns) *                                   │     31657 │     32866 │     33407 │     33751 │     33882 │     34197 │     34197 │        91 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Canada-manual-encodeToFlexbufferSharedKeys (ns) *            │      3116 │      3375 │      3391 │      3424 │      3467 │      3682 │      3812 │       881 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Canada-manual-encodeToFlexbufferSharedKeysAndStrings (ns) *  │      4008 │      4243 │      4264 │      4297 │      4321 │      4493 │      4679 │       703 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-decodeFromJSON (ns) *                                │      1242 │      1377 │      1400 │      1409 │      1417 │      1498 │      1589 │      2149 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-encodeToJSON (ns) *                                  │       646 │       704 │       714 │       727 │       735 │       753 │       828 │      4195 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-manual-encodeToFlexbufferSharedKeys (ns) *           │       280 │       308 │       313 │       317 │       322 │       333 │       378 │      9577 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-manual-encodeToFlexbufferSharedKeysAndStrings (ns) * │       604 │       664 │       671 │       679 │       685 │       709 │       789 │      4468 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-manual-reading-FlexbufferSharedKeys (ns) *           │         1 │         1 │         1 │         1 │         1 │         1 │        80 │   1524405 │
├─────────────────────────────────────────────────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Benchmarks:Twitter-manual-reading-FlexbufferSharedKeysAndStrings (ns) * │         1 │         1 │         1 │         1 │         1 │         1 │        52 │   1531897 │
╘═════════════════════════════════════════════════════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛
```
