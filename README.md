# [WIP] Benchmarks for FlexBuffers Swift

## ⚠️⚠️ WIP

- Currently Decoding Flexbuffers doesnt work
- Currently only the normal way of writing flexbuffers is supported
- The vision for the future is to add some type of Codable protocol to make it easier for users to write flexbuffers
- Havent tested the written flexbuffers Binaries 
- Test different optimizations for the Canada implementations since i am not familiar with the data yet (use indirect vectors maybe).

## Introduction

The following Repository compares the benchmarks between the native swift JSON encoder and decode 
compared to the FlexBuffers implementation. The vision of flexbuffers API within swift is to be something
similar to this:

```swift
struct Position: FlexBufferCodable { let x, y, z: Double }

let a = Position(x: 3.0, y: 4.0, z: 5.0)

let buffer: ByteBuffer = FlexBufferCoder().encode(a)

let pos = FlexBufferCoder().decode(buffer, as: Position.self)
```

## Size comparison

Within the resources folder you would find the binaries and jsons

| Keys                             | Twitter | Canada |
| -------------------------------- | :-----: | -----: |
| JSON                             |  617K   |   2.1M |
| FlexBuffer shared key            |  136K   |   2.9M |
| FlexBuffer shared key and string |   93K   |   1.9M |


## Readable Benchmarks

```
==============================================================================================================
Baseline 'Current_run'
==============================================================================================================

Host 'Mustiis-Macbook-Pro.local' with 10 'arm64' processors with 16 GB memory, running:
Darwin Kernel Version 24.4.0: Sat Feb 15 22:50:54 PST 2025; root:xnu-11417.100.533.501.4~3/RELEASE_ARM64_T6000

==========
Benchmarks
==========

Canada-decodeFromJSON
╒═══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Throughput (# / s) (K)    │        29 │        29 │        29 │        29 │        29 │        27 │        27 │        87 │
├───────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (μs) *   │        34 │        34 │        35 │        35 │        35 │        37 │        37 │        87 │
╘═══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Canada-encodeToJSON
╒═══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Throughput (# / s) (K)    │        14 │        14 │        14 │        14 │        14 │        14 │        14 │        42 │
├───────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (μs) *   │        72 │        72 │        72 │        72 │        72 │        73 │        73 │        42 │
╘═══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Canada-manual-encodeToFlexbufferSharedKeys
╒═══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Throughput (# / s) (K)    │       183 │       181 │       180 │       179 │       178 │       173 │       167 │       540 │
├───────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ns) *   │      5460 │      5513 │      5546 │      5591 │      5628 │      5788 │      5945 │       540 │
╘═══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Canada-manual-encodeToFlexbufferSharedKeysAndStrings
╒═══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Throughput (# / s) (K)    │       118 │       117 │       116 │       115 │       114 │       113 │       112 │       347 │
├───────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ns) *   │      8467 │      8585 │      8659 │      8708 │      8741 │      8839 │      8896 │       347 │
╘═══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Twitter-decodeFromJSON
╒═══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Throughput (# / s) (K)    │       354 │       353 │       352 │       349 │       344 │       330 │       314 │      1049 │
├───────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ns) *   │      2822 │      2836 │      2847 │      2869 │      2904 │      3029 │      3183 │      1049 │
╘═══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Twitter-encodeToJSON
╒═══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Throughput (# / s) (K)    │       700 │       696 │       695 │       692 │       684 │       661 │       627 │      2072 │
├───────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ns) *   │      1429 │      1438 │      1441 │      1446 │      1463 │      1512 │      1576 │      2072 │
╘═══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Twitter-manual-encodeToFlexbufferSharedKeys
╒═══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Throughput (# / s) (K)    │      1545 │      1541 │      1536 │      1529 │      1518 │      1472 │      1397 │      4576 │
├───────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ns) *   │       648 │       650 │       652 │       655 │       660 │       680 │       710 │      4576 │
╘═══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Twitter-manual-encodeToFlexbufferSharedKeysAndStrings
╒═══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                    │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞═══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Throughput (# / s) (K)    │       739 │       736 │       735 │       732 │       728 │       700 │       558 │      2193 │
├───────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ns) *   │      1355 │      1360 │      1362 │      1367 │      1374 │      1431 │      1640 │      2193 │
╘═══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛
```
